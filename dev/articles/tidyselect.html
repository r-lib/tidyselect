<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Implementing tidyselect interfaces • tidyselect</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Implementing tidyselect interfaces">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="tidyselect.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyselect</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/tidyselect.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/syntax.html">Technical description of tidyselect</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2022/10/tidyselect-1-2-0/">Version 1.2.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/tidyselect/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Implementing tidyselect interfaces</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/tidyselect/blob/main/vignettes/tidyselect.Rmd" class="external-link"><code>vignettes/tidyselect.Rmd</code></a></small>
      <div class="d-none name"><code>tidyselect.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyselect.r-lib.org">tidyselect</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span></code></pre></div>
<p>tidyselect implements a specialised sublanguage of R for selecting
variables from data frames and other data structures. A technical
description of the DSL is available in the <a href="https://tidyselect.r-lib.org/articles/syntax.html">syntax
vignette</a>.</p>
<p>In this vignette, we describe how to include tidyselect in your own
packages. If you just want to know how to use tidyselect syntax in dplyr
or tidyr, please read <code><a href="../reference/language.html">?language</a></code> instead.</p>
<div class="section level2">
<h2 id="before-we-start">Before we start<a class="anchor" aria-label="anchor" href="#before-we-start"></a>
</h2>
<div class="section level3">
<h3 id="selections-as-dots-or-as-named-arguments">Selections as dots or as named arguments<a class="anchor" aria-label="anchor" href="#selections-as-dots-or-as-named-arguments"></a>
</h3>
<p>There are two major ways of designing a function that takes
selections.</p>
<ul>
<li>
<p>Passing <strong>dots</strong> as in
<code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Interpolating <strong>named arguments</strong> as in
<code>tidyr::pivot_longer()</code>. In this case, multiple inputs can be
provided inside <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> or by using boolean operators:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="va">mpg</span> <span class="op">|</span> <span class="va">cyl</span><span class="op">)</span></span></code></pre></div>
</li>
</ul>
<p>Our general recommendation is to take dots when the main purpose of
the function is to create a new data structure based on a selection.
When the selection is accessory to the main purpose of the function,
take it as a named argument. In doubt, we recommend using named
arguments because it is easier to change a named argument to dots than
the other way around. For more advice about this, see the <a href="https://design.tidyverse.org/dots-data.html" class="external-link">Making data with
<code>...</code></a> section of the tidyverse design book.</p>
</div>
<div class="section level3">
<h3 id="do-you-need-tidyselect">Do you need tidyselect?<a class="anchor" aria-label="anchor" href="#do-you-need-tidyselect"></a>
</h3>
<p>The tools described in this vignette are rather low level. Depending
on your use case, it may be easier to wrap <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select()</a></code>.
You’ll get a data frame containing the columns selected by your user,
which you can then handle in various ways.</p>
<p>The following examples illustrate how you could write a function that
takes a selection of data and returns the corresponding data frame with
capitalised names:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Passing dots</span></span>
<span><span class="va">toupper_dots</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sel</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">sel</span>, <span class="va">toupper</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Interpolating a named argument with {{ }}</span></span>
<span><span class="va">toupper_arg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">arg</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sel</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">{</span><span class="op">{</span> <span class="va">arg</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">sel</span>, <span class="va">toupper</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">toupper_dots</span><span class="op">(</span><span class="va">mpg</span><span class="op">:</span><span class="va">disp</span>, <span class="va">vs</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 32 x 4</span></span>
<span><span class="co">#&gt;     MPG   CYL  DISP    VS</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  21       6   160     0</span></span>
<span><span class="co">#&gt; 2  21       6   160     0</span></span>
<span><span class="co">#&gt; 3  22.8     4   108     1</span></span>
<span><span class="co">#&gt; 4  21.4     6   258     1</span></span>
<span><span class="co">#&gt; # … with 28 more rows</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">toupper_arg</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">:</span><span class="va">disp</span>, <span class="va">vs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 32 x 4</span></span>
<span><span class="co">#&gt;     MPG   CYL  DISP    VS</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  21       6   160     0</span></span>
<span><span class="co">#&gt; 2  21       6   160     0</span></span>
<span><span class="co">#&gt; 3  22.8     4   108     1</span></span>
<span><span class="co">#&gt; 4  21.4     6   258     1</span></span>
<span><span class="co">#&gt; # … with 28 more rows</span></span></code></pre></div>
<p>The main advantage of the lower level tidyselect tools is that they
offer a bit more information and flexibility. Instead of returning the
selected data, they return the <strong>locations</strong> of selected
elements inside the input data. If you don’t need the selected locations
and can afford the dependency, you may consider wrapping dplyr
instead.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-selection-evaluators">The selection evaluators<a class="anchor" aria-label="anchor" href="#the-selection-evaluators"></a>
</h2>
<p>tidyselect is implemented with non-standard evaluation (NSE). This
unique feature of the R language refers to the ability of functions to
<strong>defuse</strong> (i.e. delay the execution) some or all of their
arguments, and resume evaluation later on<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;The defusing step is also known as &lt;em&gt;quoting&lt;/em&gt;.&lt;/p&gt;"><sup>1</sup></a>. Crucially, evaluation
can be resumed in a different context or according to different rules,
which is often how domain-specific languages are created in R.</p>
<div class="section level3">
<h3 id="defusing-and-resuming-evaluation-of-r-code">Defusing and resuming evaluation of R code<a class="anchor" aria-label="anchor" href="#defusing-and-resuming-evaluation-of-r-code"></a>
</h3>
<p>When a function argument is defused, R halts the evaluation of the
code and returns a defused expression instead. This expression contains
the code that describes how to compute the intended value.</p>
<p>Defuse <em>your own</em> R code with <code><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">own</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">own</span></span>
<span><span class="co">#&gt; 1 + 2</span></span></code></pre></div>
<p>Defuse <em>the user’s</em> R code with <code><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arg</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">arg</span><span class="op">)</span></span>
<span>  <span class="va">expr</span></span>
<span><span class="op">}</span></span>
<span><span class="va">user</span> <span class="op">&lt;-</span> <span class="fu">fn</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">user</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">&lt;quosure&gt;</span></span></span>
<span><span class="co">#&gt; expr: ^1 + 2</span></span>
<span><span class="co">#&gt; env:  global</span></span></code></pre></div>
<p>To resume the evaluation of the defused R code, use
<code><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">own</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span></span>
<span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">user</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>You can resume the evaluation in data context by passing a data frame
as <code>data</code> argument:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">with_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy</a></span><span class="op">(</span><span class="va">expr</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Resuming evaluation in a data context is known as <strong>data
masking</strong>. The data-vars inside the data frame are combined with
the env-vars of the environment, making it possible for users to refer
to their data variables:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="cn">NULL</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">with_data</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: object 'cyl' not found</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">with_data</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 61.875</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="resuming-defused-r-code-with-tidyselect-rules">Resuming defused R code with tidyselect rules<a class="anchor" aria-label="anchor" href="#resuming-defused-r-code-with-tidyselect-rules"></a>
</h3>
<p>Taking tidyselect selections in your functions follows the same
principles. First defuse an expression, then resume its evaluation.
Instead of <code><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy()</a></code>, we need the special interpreters
<code><a href="../reference/eval_select.html">eval_select()</a></code> and <code><a href="../reference/eval_select.html">eval_rename()</a></code>. Like
<code><a href="https://rlang.r-lib.org/reference/eval_tidy.html" class="external-link">eval_tidy()</a></code>, they take a defused expression and some data.
They return a vector of locations for the selected elements:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; mpg </span></span>
<span><span class="co">#&gt;   1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">:</span><span class="va">disp</span>, <span class="va">vs</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt;  mpg  cyl disp   vs </span></span>
<span><span class="co">#&gt;    1    2    3    8</span></span></code></pre></div>
<p>If the user has renamed some of the selected elements, the names of
the vector of locations reflect the new names.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span>, bar <span class="op">=</span> <span class="va">disp</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; foo bar </span></span>
<span><span class="co">#&gt;   1   3</span></span>
<span></span>
<span><span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span>, bar <span class="op">=</span> <span class="va">disp</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; foo bar </span></span>
<span><span class="co">#&gt;   1   3</span></span></code></pre></div>
<p><code><a href="../reference/eval_select.html">eval_select()</a></code> is most likely the variant that you’ll
need to implement your tidyselect functions.</p>
<div class="section level4">
<h4 id="simple-selections-with-dots">Simple selections with dots<a class="anchor" aria-label="anchor" href="#simple-selections-with-dots"></a>
</h4>
<p>If your selecting function takes dots:</p>
<ol style="list-style-type: decimal">
<li><p>Pass the dots to <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> inside a defused
expression.</p></li>
<li><p>Resume evaluation of the defused <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> expression with
<code><a href="../reference/eval_select.html">eval_select()</a></code>.</p></li>
<li><p>Use the vector of locations returned by
<code><a href="../reference/eval_select.html">eval_select()</a></code> to subset and rename the input data.</p></li>
</ol>
<p>Here is how to reimplement <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select()</a></code> in 3 lines
representing each of the steps above:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">select</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="va">expr</span>, data <span class="op">=</span> <span class="va">.data</span><span class="op">)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[</span><span class="va">pos</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pos</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 32 × 2</span></span></span>
<span><span class="co">#&gt;     mpg   cyl</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  21       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  21       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  22.8     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  21.4     6</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 28 more rows</span></span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="simple-selections-with-named-arguments">Simple selections with named arguments<a class="anchor" aria-label="anchor" href="#simple-selections-with-named-arguments"></a>
</h4>
<p>If your selecting function takes named arguments, the defusing step
is a bit different. We need to use <code><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo()</a></code> to defuse the
function argument itself.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">select</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span></span>
<span>  <span class="va">pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="va">expr</span>, data <span class="op">=</span> <span class="va">.data</span><span class="op">)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[</span><span class="va">pos</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pos</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 32 × 2</span></span></span>
<span><span class="co">#&gt;     mpg   cyl</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  21       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  21       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  22.8     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  21.4     6</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 28 more rows</span></span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="renaming-selections">Renaming selections<a class="anchor" aria-label="anchor" href="#renaming-selections"></a>
</h4>
<p>The <code><a href="../reference/eval_select.html">eval_rename()</a></code> variant is rarely needed and only
mentioned here for completeness. First note that both
<code><a href="../reference/eval_select.html">eval_select()</a></code> and <code><a href="../reference/eval_select.html">eval_rename()</a></code> allow renaming
variables:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; foo </span></span>
<span><span class="co">#&gt;   1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; foo </span></span>
<span><span class="co">#&gt;   1</span></span></code></pre></div>
<p><code><a href="../reference/eval_select.html">eval_rename()</a></code> is very similar to
<code><a href="../reference/eval_select.html">eval_select()</a></code> but it has more constraints because it is
meant for renaming variables in place. In particular it throws an error
if the selected inputs are unnamed. In practice,
<code><a href="../reference/eval_select.html">eval_rename()</a></code> only accepts a <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> expression as
<code>expr</code> argument, and all inputs inside the outermost
<code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> must be named:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> All renaming inputs must be named.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> All renaming inputs must be named.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; foo </span></span>
<span><span class="co">#&gt;   1</span></span></code></pre></div>
<p>Because of this constraint, it doesn’t make much sense to take a
named argument, most of the time you’ll want to pass dots to a defused
<code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> expression. This way the user can easily pass names
with the selections:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">wrapper</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span>, bar <span class="op">=</span> <span class="va">hp</span><span class="op">:</span><span class="va">wt</span><span class="op">)</span></span>
<span><span class="co">#&gt;  foo bar1 bar2 bar3 </span></span>
<span><span class="co">#&gt;    1    4    5    6</span></span></code></pre></div>
<p>As an example of how to use the vector of locations returned by
<code><a href="../reference/eval_select.html">eval_rename()</a></code>, here is how to implement
<code><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">dplyr::rename()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rename</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_select.html">eval_rename</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span>, <span class="va">.data</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">.data</span><span class="op">)</span><span class="op">[</span><span class="va">pos</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pos</span><span class="op">)</span></span>
<span>  <span class="va">.data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">mpg</span>, bar <span class="op">=</span> <span class="va">hp</span><span class="op">:</span><span class="va">wt</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 32 × 11</span></span></span>
<span><span class="co">#&gt;     foo   cyl  disp  bar1  bar2  bar3  qsec    vs    am  gear  carb</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 28 more rows</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="creating-selection-helpers">Creating selection helpers<a class="anchor" aria-label="anchor" href="#creating-selection-helpers"></a>
</h2>
<p>Tools like <code><a href="../reference/starts_with.html">starts_with()</a></code> or <code><a href="../reference/starts_with.html">contains()</a></code> are
called <strong>selection helpers</strong>. These tools inspect the
variable names currently available for selection with
<code><a href="../reference/peek_vars.html">peek_vars()</a></code>. The variable names are registered
automatically by <code><a href="../reference/eval_select.html">eval_select()</a></code> for the duration of the
evaluation:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/expr.html" class="external-link">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/peek_vars.html">peek_vars</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="../reference/eval_select.html">eval_select</a></span><span class="op">(</span><span class="va">x</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "mpg"  "cyl"  "disp" "hp"   "drat" "wt"   "qsec" "vs"   "am"  </span></span>
<span><span class="co">#&gt; [10] "gear" "carb"</span></span></code></pre></div>
<p>Such properties temporarily available by calling a function like
<code><a href="../reference/peek_vars.html">peek_vars()</a></code> are called <strong>descriptors</strong>.
Descriptors are useful because they are very easy to compose. For
instance, a user could combine <code><a href="../reference/starts_with.html">starts_with()</a></code> and
<code><a href="../reference/starts_with.html">ends_with()</a></code> without having to worry about passing the
variables or the environment in which they can be found:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_selector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prefix</span>, <span class="va">suffix</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="va">prefix</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="va">suffix</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">iris</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="fu">my_selector</span><span class="op">(</span><span class="st">"Sepal"</span>, <span class="st">"Length"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 150 × 1</span></span></span>
<span><span class="co">#&gt;   Sepal.Length</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>          5.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>          4.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>          4.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>          4.6</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 146 more rows</span></span></span></code></pre></div>
<p>To create a new selection helper:</p>
<ol style="list-style-type: decimal">
<li><p>Inspect the variables with <code><a href="../reference/peek_vars.html">peek_vars()</a></code>. By
convention this should be done in an argument that the user can
override.</p></li>
<li><p>Return one of the supported data types: vector of names or
locations (the latter is recommended, see section on handling duplicate
variables), or a predicate function.</p></li>
</ol>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">if_width</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">vars</span> <span class="op">=</span> <span class="fu"><a href="../reference/peek_vars.html">peek_vars</a></span><span class="op">(</span>fn <span class="op">=</span> <span class="st">"if_width"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span> <span class="op">==</span> <span class="va">n</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="fu">if_width</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 32 × 4</span></span></span>
<span><span class="co">#&gt;      hp    wt    vs    am</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   110  2.62     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>   110  2.88     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    93  2.32     1     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   110  3.22     1     0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 28 more rows</span></span></span></code></pre></div>
<p>The <code>fn</code> argument makes the error message more informative
when the helper is used in the wrong context:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span><span class="op">[</span><span class="fu">if_width</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> `if_width()` must be used within a *selecting* function.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See</span></span>
<span><span class="co">#&gt;   &lt;https://tidyselect.r-lib.org/reference/faq-selection-context.html&gt;</span></span>
<span><span class="co">#&gt;   for details.</span></span></code></pre></div>
<p>Because the variables are inspected in a default argument, it is easy
to override. This is mostly useful in unit tests:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">if_width</span><span class="op">(</span><span class="fl">2</span>, vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "hp" "wt" "vs" "am"</span></span></code></pre></div>
<div class="section level3">
<h3 id="handling-duplicate-variables">Handling duplicate variables<a class="anchor" aria-label="anchor" href="#handling-duplicate-variables"></a>
</h3>
<p>However our current implementation of <code>if_width()</code> has a
design flaw. It doesn’t work properly when the input has duplicate
names:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dups</span> <span class="op">&lt;-</span> <span class="fu">vctrs</span><span class="fu">::</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/new_data_frame.html" class="external-link">new_data_frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span>, quux <span class="op">=</span> <span class="fl">2</span>, foo <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dups</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="fu">if_width</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   foo</span></span>
<span><span class="co">#&gt; 1   1</span></span></code></pre></div>
<p>Supporting duplicates is recommended because data frames in the wild
don’t always have unique names. Also, tidyselect can be used with
vectors that don’t require unique names, and it might be extended to
allow recoding character vectors in the future. In these cases, handling
duplicates is part of the normal usage for selection helpers.</p>
<p>To support duplicates it is recommended to return vectors of
locations from selection helpers rather than vector of names. Fixing
<code>if_width()</code> is easy:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">if_width</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">vars</span> <span class="op">=</span> <span class="fu"><a href="../reference/peek_vars.html">peek_vars</a></span><span class="op">(</span>fn <span class="op">=</span> <span class="st">"if_width"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span> <span class="op">==</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If the input is a data frame, the user is now informed that their
selection should not contain duplicates:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dups</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="fu">if_width</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `select()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Names must be unique.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> These names are duplicated:</span></span>
<span><span class="co">#&gt;   * "foo" at locations 1 and 2.</span></span></code></pre></div>
<p>And all the duplicates are selected if the input is not a data frame,
as expected:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">dups</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="fu">if_width</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $foo</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $foo</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
